# Cache Lab

## Part A: Writing a Cache Simulator

In this part, we will write a cache simulator in `csim.c` that takes a `valgrind` memory trace as well as cache parameters as input and simulates the hit/miss behavior of a cache memory on this trace. The simulator will also output the total number of hits, misses, and evictions.

<br>

### **Reference Trace Files**

The `traces` directory contains a collection of *reference trace files*. These files are generated by `valgrind`. For example, the command
```
linux> valgrind --log-fd=1 --tool=lackey -v --trace-mem=yes ls -l
```
runs the program `ls -l` and captures a trace of its memory accesses.

`Valgrind` traces have the following form:
```
I 0400d7d4,8
 M 0421c7f0,4
 L 04f6b868,8
 S 7ff0005c8,8
```

The format of each line is
```
[space] operation address,size
```

- ***Operation***: `I` indicates instruction read, `L` indicates data load, `S` indicates data store, and `M` indicates data modify (a data load followed by a data store).
  - Note that in the trace file, all lines except the ones with `I` (instruction read) are preceded by a space.
- ***Address***: a 64-bit hexadecimal memory address.
- ***Size***: the number of bytes accessed by the operation.

<br>

### **What to do with each operation?**

- For **instruction reads**, we don't need to do anything
- For **data loads** and **data stores**, there are three possible results:
  1. *Hit*: The data we wanted was already in the cache.
  2. *Miss*: The data we wanted was not in the cache, but we were able to load the data into the cache without evicting anything else.
  3. *Miss Eviction*: The data we wanted was not in the cache, and we had to evict some other line of data before we could load the new data into the cache.
- For **data modify**, we essentially run data load followed by data store. We get a combination of the results above:
  1. *Hit*: if the load operation returned *Hit*, then we have a hit.
  2. *Miss Hit*: the load operation returned *Miss* (we were able to load the data without eviction), and then the store operation returned *Hit*.
  3. *Miss Eviction Hit*: the load operation returned *Miss Eviction*, and then the store operation returned *Hit*.

<br>

### **Consider an Example**

Take `dave.trace` as an example:

```
 L 10,4 
 S 18,4
 L 20,4
 S 28,4
 S 50,4
```

If we give 2 set index bits (number of sets $S = 2^2 = 4), an associativity of 2 ($E = 2$, 2 lines per set), and 4 block offset bits (block size $B = 2^4 = 16$), then:

1. `L 10,4`: Miss
  - The address is `0x10 = 00010000`, meaning that block offset is `0000 = 0x0`, set index is `01 = 0x1`, tag is `00 = 0x0`.
  - We load 16 bytes into the cache, from address `0x10` to `0x1F`.
2. `S 18,4`: Hit
  - The address is `0x18 = 00011000`, meaning that block offset is `1000 = 0x8`, set index is `01 = 0x1`, tag is `00 = 0x0`.
  - These 4 bytes at address `0x18` is already in the cache.
3. `L 20,4`: Miss.
  - The address is `0x20 = 00100000`, meaning that block offset is 0, set index is `10 = 0x2`, tag is `00 = 0x0`.
  - We load 16 bytes into the cache, from address `0x20` to `0x2F`.
4. ...

<br> 

### **Least Recently Used Replacement Policy**

Our cache will use a *Least Recently Used (LRU)* replacement policy, meaning that if an eviction is needed, the cache line that was used furthest in the past will be evicted.

To implement this, we can keep a **time stamp** with each of our line. When we load/modify/access a line, we set its time stamp to 0 while incrementing the time stamps of all other lines. When we need to find the LRU line, we simply look for the line with the max time stamp.

<br>

### **Additional Notes**

- We can use a `struct` to represent each cache line. The `struct` would contain the valid bit, the tag, and a time stamp.
- We can use `getopt` to fetch command-line arguments.
- Although `./test-csim` only considers the number of hits, misses, and evictions, we will also implement the other features of `./csim-ref` as well, such as verbose mode, printing help messages, and printing error messages.
- Remember to free our cache space when we are done.

<br>

### **Solution**

*See [csim.c](./cachelab-handout/csim.c).*

<br>

### **Output**

Received 27/27 points using `./test-csim`, which only checks the number of hits, misses, and evictions.

```
$ ./test-csim
                        Your simulator     Reference simulator
Points (s,E,b)    Hits  Misses  Evicts    Hits  Misses  Evicts
     3 (1,1,1)       9       8       6       9       8       6  traces/yi2.trace
     3 (4,2,4)       4       5       2       4       5       2  traces/yi.trace
     3 (2,1,4)       2       3       1       2       3       1  traces/dave.trace
     3 (2,1,3)     167      71      67     167      71      67  traces/trans.trace
     3 (2,2,3)     201      37      29     201      37      29  traces/trans.trace
     3 (2,4,3)     212      26      10     212      26      10  traces/trans.trace
     3 (5,1,5)     231       7       0     231       7       0  traces/trans.trace
     6 (5,1,5)  265189   21775   21743  265189   21775   21743  traces/long.trace
    27

TEST_CSIM_RESULTS=27
```

Verbose mode vs. non-verbose mode:

```
$ ./csim -v -s 4 -E 1 -b 4 -t traces/yi.trace
L 10, 1 miss
M 20, 1 miss hit
L 22, 1 hit
S 18, 1 hit
L 110, 1 miss eviction
L 210, 1 miss eviction
M 12, 1 miss eviction hit
hits:4 misses:5 evictions:3

$ ./csim -s 4 -E 1 -b 4 -t traces/yi.trace
hits:4 misses:5 evictions:3
```

Error message with missing required arguments:

```
$ ./csim -s 4
./csim: Missing required command line argument
Usage: ./csim [-hv] -s <num> -E <num> -b <num> -t <file>
Options:
  -h         Print this help message.
  -v         Optional verbose flag.
  -s <num>   Number of set index bits.
  -E <num>   Number of lines per set.
  -b <num>   Number of block offset bits.
  -t <file>  Trace file.

Examples:
  linux>  ./csim -s 4 -E 1 -b 4 -t traces/yi.trace
  linux>  ./csim -v -s 8 -E 2 -b 4 -t traces/yi.trace
```

Error message when option has missing argument:

```
$ ./csim -s
./csim: option requires an argument -- 's'
Usage: ./csim [-hv] -s <num> -E <num> -b <num> -t <file>
Options:
  -h         Print this help message.
  -v         Optional verbose flag.
  -s <num>   Number of set index bits.
  -E <num>   Number of lines per set.
  -b <num>   Number of block offset bits.
  -t <file>  Trace file.

Examples:
  linux>  ./csim -s 4 -E 1 -b 4 -t traces/yi.trace
  linux>  ./csim -v -s 8 -E 2 -b 4 -t traces/yi.trace
```

<br>

## Part B: Optimizing Matrix Transpose

